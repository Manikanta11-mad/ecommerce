<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shopper App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    :root {
      --bg: #f4f4f4;
      --text: #000;
    }
    [data-theme="dark"] {
      --bg: #121212;
      --text: #ffffff;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: all 0.3s ease;
    }
    .card, .form-box, .modal-content {
      background-color: var(--bg);
      color: var(--text);
    }
    #loginPage, #signupPage, #mainPage { display: none; }
    .form-box {
      max-width: 400px;
      margin: 100px auto;
      background: var(--bg);
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    header a {
      text-decoration: none;
      color: white;
    }
    header a:hover {
      color: red;
    }
    .icon-btn {
      font-size: 1.5rem;
      color: white;
      margin-right: 15px;
      position: relative;
    }
    @media (max-width: 768px) {
      header h3 { font-size: 1.2rem; }
      .form-box { margin: 50px 15px; }
    }
  </style>
</head>
<body onload="init()" data-theme="light">

  <!-- Login Page -->
  <div id="loginPage" class="animate__animated animate__fadeIn">
    <div class="form-box">
      <h3 class="text-center">Login</h3>
      <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
      <input type="password" id="loginPassword" class="form-control mb-3" placeholder="Password">
      <button class="btn btn-primary w-100 mb-2" onclick="handleLogin()">Login</button>
      <p class="text-center">New user? <a href="#" onclick="showSignup()">Sign up</a></p>
    </div>
  </div>

  <!-- Signup Page -->
  <div id="signupPage" class="animate__animated animate__fadeIn">
    <div class="form-box">
      <h3 class="text-center">Sign Up</h3>
      <input type="email" id="signupEmail" class="form-control mb-2" placeholder="Email">
      <input type="password" id="signupPassword" class="form-control mb-3" placeholder="Password">
      <button class="btn btn-success w-100 mb-2" onclick="handleSignup()">Register</button>
      <p class="text-center">Already registered? <a href="#" onclick="showLogin()">Login</a></p>
    </div>
  </div>

  <!-- Main Page -->
  <div id="mainPage">
    <header class="container-fluid bg-dark text-white p-3 d-flex flex-wrap justify-content-between align-items-center">
      <h3>Shopper</h3>
      
      <!-- Desktop Links -->
      <div class="d-none d-md-flex gap-3 align-items-center">
        <a href="#" onclick="NavClicked('all')">Home</a>
        <a href="#" onclick="NavClicked('electronics')">Electronics</a>
        <a href="#" onclick="NavClicked('jewelery')">Jewellery</a>
        <a href="#" onclick="NavClicked(`men's clothing`)">Mens</a>
        <a href="#" onclick="NavClicked(`women's clothing`)">Womens</a>
      </div>

      <!-- Mobile Dropdown -->
      <div class="d-md-none w-100 mt-2">
        <select class="form-select" onchange="NavClicked(this.value)">
          <option value="all">Home</option>
          <option value="electronics">Electronics</option>
          <option value="jewelery">Jewellery</option>
          <option value="men's clothing">Mens</option>
          <option value="women's clothing">Womens</option>
        </select>
      </div>

      <!-- Right-side icons -->
      <div class="d-flex align-items-center mt-2 mt-md-0">
        <a href="#" class="icon-btn" onclick="showWishlist()"><i class="bi bi-heart"></i><span id="wishlistCount" class="position-absolute top-0 start-100 translate-middle badge bg-danger">0</span></a>
        <a href="#" class="icon-btn" onclick="CartClick()" data-bs-toggle="modal" data-bs-target="#cartModal"><i class="bi bi-cart"></i><span id="lblCount" class="position-absolute top-0 start-100 translate-middle badge bg-danger">0</span></a>
        <button class="btn btn-outline-light btn-sm ms-2" onclick="toggleTheme()"><span id="themeIcon">üåô</span></button>
        <button class="btn btn-outline-light btn-sm ms-2" onclick="logout()">Logout</button>
      </div>
    </header>

    <!-- Content -->
    <section class="container-fluid mt-3">
      <div class="row flex-column flex-md-row">
        <nav class="col-md-2 col-12 mb-3">
          <label class="form-label">Select Category</label>
          <select class="form-select" id="lstcategories" onchange="categorychange()"></select>
        </nav>
        <main class="col-md-10 col-12 d-flex flex-wrap justify-content-center gap-3"></main>
      </div>
    </section>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5>Your Cart</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><table class="table"><tbody id="cartBody"></tbody></table></div>
        <div class="modal-footer">
          <button class="btn btn-danger" onclick="clearCart()">Clear All</button>
          <button class="btn btn-success" onclick="payNow()">Pay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Wishlist Modal -->
  <div class="modal fade" id="wishlistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5>Your Wishlist</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><ul class="list-group" id="wishlistBody"></ul></div>
        <div class="modal-footer"><button class="btn btn-danger" onclick="clearWishlist()">Clear All</button></div>
      </div>
    </div>
  </div>

  <script>
    emailjs.init("I8Dh42emZsy-d7Pkt");

    let cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
    let wishlistItems = JSON.parse(localStorage.getItem("wishlist") || "[]");

    function init() {
      const user = localStorage.getItem("loggedInUser");
      if (user) {
        document.getElementById("mainPage").style.display = "block";
        loadcategories(); loadproducts("https://fakestoreapi.com/products/"); updateCounts();
      } else {
        document.getElementById("loginPage").style.display = "block";
      }
    }

    function handleSignup() {
      const email = signupEmail.value;
      const password = signupPassword.value;
      if (email && password.length >= 6) {
        localStorage.setItem("registeredUser", JSON.stringify({ email, password }));
        alert("Registration successful!");
        showLogin();
      } else {
        alert("Enter valid email and password (min 6 chars)");
      }
    }

    function handleLogin() {
      const email = loginEmail.value;
      const password = loginPassword.value;
      const savedUser = JSON.parse(localStorage.getItem("registeredUser"));
      if (savedUser && email === savedUser.email && password === savedUser.password) {
        localStorage.setItem("loggedInUser", email);
        sendLoginNotification(email);
        showMain();
      } else {
        alert("Invalid credentials. Please try again or sign up.");
      }
    }

    function sendLoginNotification(userEmail) {
      emailjs.send("service_avrdsmo", "template_cg7k1pw", {
        to_email: "maniklanta00645@gmail.com",
        message: `Login successful at ${new Date().toLocaleString()} with ${userEmail}`
      });
    }

    function showSignup() {
      loginPage.style.display = "none";
      signupPage.style.display = "block";
    }

    function showLogin() {
      signupPage.style.display = "none";
      loginPage.style.display = "block";
    }

    function showMain() {
      loginPage.style.display = "none";
      signupPage.style.display = "none";
      mainPage.style.display = "block";
      loadcategories(); loadproducts("https://fakestoreapi.com/products/"); updateCounts();
    }

    function logout() {
      localStorage.removeItem("loggedInUser");
      location.reload();
    }

    function loadcategories() {
      fetch("https://fakestoreapi.com/products/categories")
        .then(res => res.json())
        .then(cats => {
          cats.unshift("all");
          lstcategories.innerHTML = cats.map(c => `<option>${c}</option>`).join("");
        });
    }

    function loadproducts(url) {
      fetch(url).then(res => res.json()).then(products => {
        document.querySelector("main").innerHTML = "";
        products.forEach(p => {
          const card = document.createElement("div");
          card.className = "card p-2 flex-grow-1";
          card.style.minWidth = "180px";
          card.style.maxWidth = "250px";
          card.innerHTML = `
            <img src="${p.image}" class="card-img-top" height="160">
            <div class="card-header" style="height:120px;"><p>${p.title}</p></div>
            <div class="card-body"><strong>$${p.price}</strong><br><small>Rating: ${p.rating.rate}</small></div>
            <div class="card-footer d-flex flex-column gap-1">
              <button class="btn btn-danger" onclick="AddToCart(${p.id})">Add to Cart</button>
              <button class="btn btn-outline-warning" onclick="AddToWishlist(${p.id})">Wishlist</button>
            </div>`;
          document.querySelector("main").appendChild(card);
        });
      });
    }

    function categorychange() {
      const cat = lstcategories.value;
      const url = cat === "all" ? "https://fakestoreapi.com/products/" : `https://fakestoreapi.com/products/category/${cat}`;
      loadproducts(url);
    }

    function NavClicked(category) {
      loadproducts(`https://fakestoreapi.com/products/category/${category}`);
    }

    function AddToCart(id) {
      fetch(`https://fakestoreapi.com/products/${id}`).then(res => res.json()).then(p => {
        cartItems.push(p);
        localStorage.setItem("cart", JSON.stringify(cartItems));
        updateCounts();
        alert(`${p.title} added to cart`);
      });
    }

    function AddToWishlist(id) {
      fetch(`https://fakestoreapi.com/products/${id}`).then(res => res.json()).then(p => {
        wishlistItems.push(p);
        localStorage.setItem("wishlist", JSON.stringify(wishlistItems));
        updateCounts();
        alert(`${p.title} added to wishlist`);
      });
    }

    function updateCounts() {
      wishlistCount.innerText = wishlistItems.length;
      lblCount.innerText = cartItems.length;
    }

    function CartClick() {
      cartBody.innerHTML = cartItems.map((p, i) => `
        <tr>
          <td>${p.title}</td>
          <td>$${p.price}</td>
          <td><img src="${p.image}" width="50"/></td>
          <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${i})">Remove</button></td>
        </tr>`).join("");
    }

    function removeFromCart(i) {
      cartItems.splice(i, 1);
      localStorage.setItem("cart", JSON.stringify(cartItems));
      updateCounts(); CartClick();
    }

    function showWishlist() {
      wishlistBody.innerHTML = wishlistItems.map((p, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${p.title}<div><img src="${p.image}" width="40"><button class="btn btn-sm btn-danger ms-2" onclick="removeFromWishlist(${i})">Remove</button></div>
        </li>`).join("");
      new bootstrap.Modal(wishlistModal).show();
    }

    function removeFromWishlist(i) {
      wishlistItems.splice(i, 1);
      localStorage.setItem("wishlist", JSON.stringify(wishlistItems));
      updateCounts(); showWishlist();
    }

    function clearCart() {
      if (confirm("Clear all cart items?")) {
        cartItems = []; localStorage.setItem("cart", "[]"); updateCounts(); CartClick();
      }
    }

    function clearWishlist() {
      if (confirm("Clear wishlist?")) {
        wishlistItems = []; localStorage.setItem("wishlist", "[]"); updateCounts(); showWishlist();
      }
    }

    function payNow() {
      const total = cartItems.reduce((sum, p) => sum + p.price, 0);
      const options = {
        key: "rzp_test_1DP5mmOlF5G5ag",
        amount: total * 100,
        currency: "INR",
        name: "Shopper",
        description: "Order Payment",
        handler: function (response) {
          const paymentId = response.razorpay_payment_id;
          alert("Payment successful!\nPayment ID: " + paymentId);
          downloadReceipt(paymentId, total);
          cartItems = []; localStorage.setItem("cart", "[]"); updateCounts(); CartClick();
        }
      };
      new Razorpay(options).open();
    }

    function downloadReceipt(paymentId, total) {
      const receipt = `
Shopper App Receipt
-----------------------------
Payment ID: ${paymentId}
Date: ${new Date().toLocaleString()}
Total: ‚Çπ${total.toFixed(2)}

Items:
${cartItems.map(p => ` - ${p.title} @ ‚Çπ${p.price}`).join("\n")}

Thank you for shopping with us!
      `;
      const blob = new Blob([receipt], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `Shopper_Receipt_${paymentId}.txt`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function toggleTheme() {
      const isDark = document.body.getAttribute("data-theme") === "dark";
      document.body.setAttribute("data-theme", isDark ? "light" : "dark");
      document.getElementById("themeIcon").textContent = isDark ? "üåô" : "‚òÄÔ∏è";
    }
  </script>
</body>
</html>
