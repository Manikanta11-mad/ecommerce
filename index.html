<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Shopper App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@2.6.4/dist/email.min.js"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; }
    #loginPage, #signupPage, #mainPage { display: none; }
    .form-box { max-width: 400px; margin: 100px auto; background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 20px rgba(0,0,0,0.1); }
    header a { text-decoration: none; color: white; }
    header a:hover { color: red; }
    .icon-btn { font-size: 1.5rem; color: white; margin-right: 15px; position: relative; }
  </style>
</head>
<body onload="init()">

  <!-- Login Page -->
  <div id="loginPage" class="animate__animated animate__fadeIn">
    <div class="form-box">
      <h3 class="text-center">Login</h3>
      <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
      <input type="password" id="loginPassword" class="form-control mb-3" placeholder="Password">
      <button class="btn btn-primary w-100 mb-2" onclick="handleLogin()">Login</button>
      <p class="text-center">New user? <a href="#" onclick="showSignup()">Sign up</a></p>
    </div>
  </div>

  <!-- Signup Page -->
  <div id="signupPage" class="animate__animated animate__fadeIn">
    <div class="form-box">
      <h3 class="text-center">Sign Up</h3>
      <input type="email" id="signupEmail" class="form-control mb-2" placeholder="Email">
      <input type="password" id="signupPassword" class="form-control mb-3" placeholder="Password">
      <button class="btn btn-success w-100 mb-2" onclick="handleSignup()">Register</button>
      <p class="text-center">Already registered? <a href="#" onclick="showLogin()">Login</a></p>
    </div>
  </div>

  <!-- Main Page -->
  <div id="mainPage">
    <header class="container-fluid d-flex justify-content-between bg-dark text-white p-3">
      <h3>Shopper</h3>
      <div>
        <span class="me-3"><a href="#" onclick="NavClicked('all')">Home</a></span>
        <span class="me-3"><a href="#" onclick="NavClicked('electronics')">Electronics</a></span>
        <span class="me-3"><a href="#" onclick="NavClicked('jewelery')">Jewellery</a></span>
        <span class="me-3"><a href="#" onclick="NavClicked(`men's clothing`)">Mens</a></span>
        <span class="me-3"><a href="#" onclick="NavClicked(`women's clothing`)">Womens</a></span>
      </div>
      <div class="d-flex align-items-center">
        <a href="#" class="icon-btn" onclick="showWishlist()"><i class="bi bi-heart"></i><span id="wishlistCount" class="position-absolute top-0 start-100 translate-middle badge bg-danger">0</span></a>
        <a href="#" class="icon-btn" onclick="CartClick()" data-bs-toggle="modal" data-bs-target="#cartModal"><i class="bi bi-cart"></i><span id="lblCount" class="position-absolute top-0 start-100 translate-middle badge bg-danger">0</span></a>
        <button class="btn btn-outline-light btn-sm ms-3" onclick="logout()">Logout</button>
      </div>
    </header>
    <section class="row m-2">
      <nav class="col-2">
        <label>Select Category</label>
        <select class="form-control" id="lstcategories" onchange="categorychange()"></select>
      </nav>
      <main class="col-10 d-flex flex-wrap"></main>
    </section>
  </div>

  <!-- Cart Modal -->
  <div class="modal fade" id="cartModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5>Your Cart</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><table class="table"><tbody id="cartBody"></tbody></table></div>
        <div class="modal-footer">
          <button class="btn btn-danger" onclick="clearCart()">Clear All</button>
          <button class="btn btn-success" onclick="payNow()">Pay</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Wishlist Modal -->
  <div class="modal fade" id="wishlistModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header"><h5>Your Wishlist</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
        <div class="modal-body"><ul class="list-group" id="wishlistBody"></ul></div>
        <div class="modal-footer"><button class="btn btn-danger" onclick="clearWishlist()">Clear All</button></div>
      </div>
    </div>
  </div>

  <script>
    emailjs.init("I8Dh42emZsy-d7Pkt"); // Your EmailJS Public Key

    let cartItems = JSON.parse(localStorage.getItem("cart") || "[]");
    let wishlistItems = JSON.parse(localStorage.getItem("wishlist") || "[]");

    function init() {
      const user = localStorage.getItem("loggedInUser");
      if (user) {
        document.getElementById("mainPage").style.display = "block";
        loadcategories(); loadproducts("https://fakestoreapi.com/products/"); updateCounts();
      } else {
        document.getElementById("loginPage").style.display = "block";
      }
    }

    function handleSignup() {
      const email = signupEmail.value;
      const password = signupPassword.value;
      if (email && password.length >= 6) {
        localStorage.setItem("registeredUser", JSON.stringify({ email, password }));
        alert("Registration successful!");
        showLogin();
      } else {
        alert("Enter valid email and password (min 6 chars)");
      }
    }

    function handleLogin() {
      const email = loginEmail.value;
      const password = loginPassword.value;
      const savedUser = JSON.parse(localStorage.getItem("registeredUser"));

      if (savedUser && email === savedUser.email && password === savedUser.password) {
        localStorage.setItem("loggedInUser", email);
        sendLoginNotification(email); // Send email to the user
        showMain();
      } else {
        alert("Invalid credentials. Please try again or sign up.");
      }
    }

    function sendLoginNotification(userEmail) {
      emailjs.send("service_avrdsmo", "template_cg7k1pw", {
        to_email: "maniklanta00645@gmail.com",
        message: `Hello,\n\nYou have successfully logged in to the Shopper App.\n\nLogin Email: ${userEmail}\nTime: ${new Date().toLocaleString()}\n\nIf this wasn't you, please contact support immediately.\n\nThank you!`
      }).then(() => {
        console.log("Login confirmation sent to user.");
      }).catch(console.error);
    }

    function showSignup() {
      loginPage.style.display = "none";
      signupPage.style.display = "block";
    }

    function showLogin() {
      signupPage.style.display = "none";
      loginPage.style.display = "block";
    }

    function showMain() {
      loginPage.style.display = "none";
      signupPage.style.display = "none";
      mainPage.style.display = "block";
      loadcategories(); loadproducts("https://fakestoreapi.com/products/"); updateCounts();
    }

    function logout() {
      localStorage.removeItem("loggedInUser");
      location.reload();
    }

    function loadcategories() {
      fetch("https://fakestoreapi.com/products/categories")
        .then(res => res.json())
        .then(cats => {
          cats.unshift("all");
          lstcategories.innerHTML = cats.map(c => `<option>${c}</option>`).join("");
        });
    }

    function loadproducts(url) {
      fetch(url).then(res => res.json()).then(products => {
        document.querySelector("main").innerHTML = "";
        products.forEach(p => {
          const card = document.createElement("div");
          card.className = "card m-2 p-2";
          card.style.width = "200px";
          card.innerHTML = `
            <img src="${p.image}" class="card-img-top" height="160">
            <div class="card-header" style="height:120px;"><p>${p.title}</p></div>
            <div class="card-body"><strong>$${p.price}</strong><br><small>Rating: ${p.rating.rate}</small></div>
            <div class="card-footer d-flex flex-column gap-1">
              <button class="btn btn-danger" onclick="AddToCart(${p.id})">Add to Cart</button>
              <button class="btn btn-outline-warning" onclick="AddToWishlist(${p.id})">Wishlist</button>
            </div>`;
          document.querySelector("main").appendChild(card);
        });
      });
    }

    function categorychange() {
      const cat = lstcategories.value;
      const url = cat === "all" ? "https://fakestoreapi.com/products/" : `https://fakestoreapi.com/products/category/${cat}`;
      loadproducts(url);
    }

    function NavClicked(category) {
      loadproducts(`https://fakestoreapi.com/products/category/${category}`);
    }

    function AddToCart(id) {
      fetch(`https://fakestoreapi.com/products/${id}`).then(res => res.json()).then(p => {
        cartItems.push(p);
        localStorage.setItem("cart", JSON.stringify(cartItems));
        updateCounts();
        alert(`${p.title} added to cart`);
      });
    }

    function AddToWishlist(id) {
      fetch(`https://fakestoreapi.com/products/${id}`).then(res => res.json()).then(p => {
        wishlistItems.push(p);
        localStorage.setItem("wishlist", JSON.stringify(wishlistItems));
        updateCounts();
        alert(`${p.title} added to wishlist`);
      });
    }

    function updateCounts() {
      wishlistCount.innerText = wishlistItems.length;
      lblCount.innerText = cartItems.length;
    }

    function CartClick() {
      cartBody.innerHTML = cartItems.map((p, i) => `
        <tr>
          <td>${p.title}</td>
          <td>$${p.price}</td>
          <td><img src="${p.image}" width="50"/></td>
          <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${i})">Remove</button></td>
        </tr>`).join("");
    }

    function removeFromCart(i) {
      cartItems.splice(i, 1);
      localStorage.setItem("cart", JSON.stringify(cartItems));
      updateCounts(); CartClick();
    }

    function showWishlist() {
      wishlistBody.innerHTML = wishlistItems.map((p, i) => `
        <li class="list-group-item d-flex justify-content-between align-items-center">
          ${p.title}<div><img src="${p.image}" width="40"><button class="btn btn-sm btn-danger ms-2" onclick="removeFromWishlist(${i})">Remove</button></div>
        </li>`).join("");
      new bootstrap.Modal(wishlistModal).show();
    }

    function removeFromWishlist(i) {
      wishlistItems.splice(i, 1);
      localStorage.setItem("wishlist", JSON.stringify(wishlistItems));
      updateCounts(); showWishlist();
    }

    function clearCart() {
      if (confirm("Clear all cart items?")) {
        cartItems = []; localStorage.setItem("cart", "[]"); updateCounts(); CartClick();
      }
    }

    function clearWishlist() {
      if (confirm("Clear wishlist?")) {
        wishlistItems = []; localStorage.setItem("wishlist", "[]"); updateCounts(); showWishlist();
      }
    }

    function payNow() {
      const total = cartItems.reduce((sum, p) => sum + p.price, 0);
      const options = {
        key: "rzp_test_1DP5mmOlF5G5ag",
        amount: total * 100,
        currency: "INR",
        name: "Shopper",
        description: "Order Payment",
        handler: function (response) {
          alert("Payment ID: " + response.razorpay_payment_id);
          cartItems = []; localStorage.setItem("cart", "[]"); updateCounts(); CartClick();
        }
      };
      new Razorpay(options).open();
    }
  </script>
</body>
</html>
